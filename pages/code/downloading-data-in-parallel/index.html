<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Eric Rochester — Downloading Data in Parallel</title>
        <meta name="description" content>
        <meta name="viewport" content="width=device-width">

        <link rel="alternate" type="application/atom+xml" href="../../../atom.xml" title="Atom Feed">

        <link href="http://fonts.googleapis.com/css?family=Inder" rel="stylesheet" type="text/css">
        <link href="http://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="../../../css/normalize.css">
        <link rel="stylesheet" href="../../../css/main.css">
        <link rel="stylesheet" href="../../../css/font-awesome.min.css">
        <link rel="stylesheet" href="../../../css/syntax.css">
        <script src="../../../js/vendor/modernizr-2.6.2.min.js"></script>
        
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="container">
          <header id="top">
            <h1><a href="../../../">Eric Rochester</a></h1>
          </header>

          <div>
            <article>
  <header>
    <h2>Downloading Data in Parallel</h2>
  </header>

  <div>
    <blockquote>
<p><em>This is a recipe that I wrote for the <a href="../../../pages/announcements/clj-data-analysis/index.html"><em>Clojure Data Analysis Cookbook</em></a>. However, it didn’t make it into the final book, so I’m sharing it with you today. If you like this, check out <a href="http://www.packtpub.com/clojure-data-analysis-cookbook/book">the book</a>.</em></p>
</blockquote>
<p>Sometimes when getting resources, we have to download them from many URLs. Doing that sequentially for one or two sources is fine, but if there are too many, we will really want to make better use of our Internet connection by downloading several at once.</p>
<p>This recipe does that. It chunks a sequence of URLs and downloads a block in parallel. It uses the <a href="http://neotyk.github.com/http.async.client/"><code>http.async.client</code></a> library to perform the download asynchronously, and we’ll simply manage how we trigger those jobs.</p>
<h3 id="getting-ready">Getting ready…</h3>
<p>First, we need to make sure that our <a href="http://leiningen.org/">Leiningen</a> <a href="project.clj"><code>project.clj</code></a> file lists the dependencies we’ll need:</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure"><span class="kw">:dependencies</span> [[org.clojure/clojure <span class="st">&quot;1.4.0&quot;</span>]
               [http.async.client <span class="st">&quot;0.4.5&quot;</span>]]</code></pre></div>
<p>And we need to use those in our script or REPL.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(<span class="kw">require</span> '[http.async.client <span class="kw">:as</span> http])
(<span class="kw">import</span> [java.net URL])</code></pre></div>
<p>For this example, we’ll download all of the ZIP files related to the <a href="http://www.who.int/whosis/mort/">World Health Organization’s mortality data</a>. Let’s bind those to the name <code>urls</code>.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(<span class="kw">def</span><span class="fu"> urls </span>
  (<span class="kw">let</span> [who-ftp 
        (<span class="kw">str</span> <span class="st">&quot;http://www.who.int/whosis/database/&quot;</span>
             <span class="st">&quot;mort/download/ftp/&quot;</span>)]
    [(<span class="kw">str</span> who-ftp <span class="st">&quot;documentation.zip&quot;</span>)
     (<span class="kw">str</span> who-ftp <span class="st">&quot;availability.zip&quot;</span>)
     (<span class="kw">str</span> who-ftp <span class="st">&quot;country_codes.zip&quot;</span>)
     (<span class="kw">str</span> who-ftp <span class="st">&quot;notes.zip&quot;</span>)
     (<span class="kw">str</span> who-ftp <span class="st">&quot;Pop.zip&quot;</span>)
     (<span class="kw">str</span> who-ftp <span class="st">&quot;morticd07.zip&quot;</span>)
     (<span class="kw">str</span> who-ftp <span class="st">&quot;morticd08.zip&quot;</span>)
     (<span class="kw">str</span> who-ftp <span class="st">&quot;morticd09.zip&quot;</span>)
     (<span class="kw">str</span> who-ftp <span class="st">&quot;morticd10.zip&quot;</span>)]))</code></pre></div>
<h3 id="how-to-do-it">How to do it…</h3>
<p>First, let’s set our default block size. We’ll do this using a dynamic variable so we can easily change it with the <code>binding</code> form.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(<span class="kw">def</span><span class="fu"> </span>^<span class="kw">:dynamic</span> *block-size* <span class="dv">3</span>)</code></pre></div>
<p>Now, we want to be able to see what we’re doing, so let’s wrap the <code>http.async.client/GET</code> function in a function that prints the URL when we start and returns the URL and the download.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(<span class="kw">defn</span><span class="fu"> get-verbose</span>
  <span class="st">&quot;This uses http.async.client to download a URL.&quot;</span>
  [client url]
  (<span class="kw">println</span> <span class="st">&quot;GET&quot;</span> url)
  [url (http/GET client url)])</code></pre></div>
<p>Next, let’s take the output of <code>get-verbose</code> and force the response. Since we don’t care about the response itself, we’ll throw most of it away and just return the status information. Because we’re curious, this will also print out information as it’s working.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(<span class="kw">defn</span><span class="fu"> get-response</span>
  <span class="st">&quot;This forces the response to download and prints out</span>
<span class="st">  what's happening.&quot;</span>
  [[url resp]]
  (<span class="kw">println</span> <span class="st">&quot;awaiting&quot;</span> url)
  (http/await resp)
  (<span class="kw">println</span> <span class="st">&quot;done&quot;</span> url)
  (http/status resp))</code></pre></div>
<p>To see how this will work, let’s write a function to download all of the URLs sequentially. This will also serve as a baseline to see how much of a speed-up we will get.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(<span class="kw">defn</span><span class="fu"> sequential</span>
  <span class="st">&quot;This downloads the resources sequentially.&quot;</span>
  []
  (<span class="kw">with-open</span> [client (http/create-client
                       <span class="kw">:follow-redirects</span> true)]
    (<span class="kw">doall</span>
      (<span class="kw">map</span> get-response
           (<span class="kw">map</span> (<span class="kw">partial</span> get-verbose client)
                urls)))))</code></pre></div>
<p>Now to process the blocks, we’ll partition the URLs using <code>partition-all</code> and use a new function, <code>get-block</code>, to force all the downloads in each block to complete before we move on to the next block.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">(<span class="kw">defn</span><span class="fu"> get-block</span>
  <span class="st">&quot;This forces a block of responses to download.&quot;</span>
  [block]
  (<span class="kw">doall</span> (<span class="kw">map</span> get-response block)))
(<span class="kw">defn</span><span class="fu"> async</span>
  <span class="st">&quot;This downloads the resources asynchronously.&quot;</span>
  []
  (<span class="kw">with-open</span> [client (http/create-client
                       <span class="kw">:follow-redirects</span> true)]
    (<span class="kw">doall</span>
      (<span class="kw">mapcat</span> get-block
              (partition-all
                *block-size*
                (<span class="kw">map</span>
                  (<span class="kw">partial</span> get-verbose client)
                  urls))))))</code></pre></div>
<p>Now we run this by simply calling async.</p>
<div class="sourceCode"><pre class="sourceCode clojure"><code class="sourceCode clojure">user=&gt; (async)
GET http://www.who.int/whosis/database/mort/download/ftp/documentation.zip
…</code></pre></div>
<h3 id="how-it-works">How it works…</h3>
<p>First, we partition the URLs into blocks that will be downloaded in parallel. Because this process is IO-bound, we don’t have to worry about matching the number of CPUs on our machines. The function <code>get-block</code> then takes each block and forces <code>get-response</code> to complete the download and return.</p>
<p>Playing around with the block size shows some impressive speed-ups. Using a block size of five takes almost half the time as the serial version. Experiment with a small subset of your downloads to see what the optimal block size is for your network and the resources you’re interested in.</p>
<hr />
<blockquote>
<p><em>This post is a literate programming file. Click on the <a href="index.clj">raw</a> link below—and the <a href="project.clj" class="uri">project.clj</a> file linked to above—to download a version of this post that you can load directly into a Clojure REPL.</em> <!-- vim: set textwidth=58: --></p>
</blockquote>
  </div>

  <footer>
    <ul>
      <li><time datetime="2013-04-29T13:04:02Z" pubdate>29 April 2013</time></li>
      <li><a href="../../../pages/code/downloading-data-in-parallel/index.html">Permalink</a></li>
      <li><a href="../../../pages/code/downloading-data-in-parallel/index.clj"><code>Raw</code></a></li>
    </ul>
  </footer>
</article>

          </div>

          <footer>
            <div>
              <div class="column">
                <h1>Links</h1>
                <ul>
                  <li><a href="../../../">Home</a></li>
                  <li><a href="../../../pages/">Index</a></li>
                  <li><a href="../../../categories/">Categories</a></li>
                </ul>
              </div>
              <div class="column">
                <h1>Writing</h1>
                <ul>
                  <li><a href="../../../clj-data-analysis/">Clojure Data Analysis Cookbook</a></li>
                  <li><a href="../../../clj-data-master/">Mastering Clojure Data Analysis</a></li>
                </ul>
              <!-- </div>
            <div class='column'> -->
                <h1>Projects</h1>
              </div>
              <div class="column">
                <div class="profile">
                  <h1>About Me</h1>
                  <div><img src="http://www.gravatar.com/avatar/0e72db523b0c799c871b7755eda209f5.png" class="avatar">
                        Dissertated on lexicography. Now I program in Haskell
                        and write when I’m not building cool stuff for the
                        Scholars’ Lab. Also, partner and parent. Do you notice
                        that <em>sleep</em> isn’t on that list? <em>Coffee</em>
                        is.
                  </div>
                </div>
              </div>
              <div class="column">
                <div class="contact">
                  <h1>Contact Me</h1>
                  <ul>
                    <li><a href="https://twitter.com/erochest"><i class="icon-twitter"></i></a></li>
                    <li><a href="https://github.com/erochest"><i class="icon-github-alt"></i></a></li>
                    <li><a href="https://plus.google.com/114676222173328397142"><i class="icon-google-plus"></i></a></li>
                    <li><a href="http://www.linkedin.com/in/erochester"><i class="icon-linkedin"></i></a></li>
                </ul>
                </div>
                <ul>
                  <li><div><a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/80x15.png" /></a><!-- <br /><span
                        xmlns:dct="http://purl.org/dc/terms/"
                        property="dct:title">Title of work</span> by <a
                        xmlns:cc="http://creativecommons.org/ns#"
                        href="http://www.ericrochester.com/something"
                        property="cc:attributionName" rel="cc:attributionURL">Eric
                        Rochester</a> is licensed under a <a rel="license"
                        href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative
                        Commons Attribution-ShareAlike 3.0 Unported License</a>.
                      --> </div></li>
                  <li>Copyright &copy; 2013, Eric Rochester</li>

                </ul>
              </div>
            </div>
            <div class="clearfix"></div>
          </footer>
        </div>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="/js/vendor/jquery-1.9.0.min.js"><\/script>')</script>
        <script src="../../../js/plugins.js"></script>
        <script src="../../../js/main.js"></script>

        <script>
            var _gaq=[['_setAccount','UA-1756003-2'],['_trackPageview']];
            (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
            g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g,s)}(document,'script'));
        </script>
    </body>
</html>
